{% extends "base.html" %}

{% block title %}Upload Lesson Plan - AI Annotator{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h2 class="card-title mb-0">
                    <i class="fas fa-upload me-2"></i>Upload Your Lesson Plan
                </h2>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Upload a PDF lesson plan and get AI-powered annotations and insights. 
                    Customize the analysis parameters to focus on specific aspects of your lesson.
                </p>

                <form action="{{ url_for('upload_file') }}" method="POST" enctype="multipart/form-data" id="uploadForm">
                    <!-- File Upload -->
                    <div class="mb-4">
                        <label for="file" class="form-label">
                            <i class="fas fa-file-pdf me-2"></i>Lesson Plan PDF
                        </label>
                        <input type="file" class="form-control" id="file" name="file" accept=".pdf" required>
                        <div class="form-text">Maximum file size: 16MB</div>
                    </div>

                    <!-- Saved Profiles (for logged-in users) -->
                    {% if current_user.is_authenticated and user_profiles %}
                    <div class="mb-4">
                        <label for="saved_profile" class="form-label">
                            <i class="fas fa-bookmark me-2"></i>My Saved Profiles
                        </label>
                        <select class="form-select" id="saved_profile" name="saved_profile" onchange="loadSavedProfile()">
                            <option value="">-- Select a saved profile --</option>
                            {% for profile in user_profiles %}
                                <option value="{{ profile.id }}" {% if profile.is_default %}selected{% endif %}>
                                    {{ profile.name }}{% if profile.is_default %} (Default){% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            Load your custom annotation settings 
                            <a href="{{ url_for('profiles') }}" class="text-decoration-none">
                                <i class="fas fa-cog"></i> Manage Profiles
                            </a>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Annotation Preset -->
                    <div class="mb-4">
                        <label for="preset" class="form-label">
                            <i class="fas fa-cogs me-2"></i>Annotation Preset
                        </label>
                        <select class="form-select" id="preset" name="preset" onchange="toggleCustomParameters()">
                            {% for preset_key, preset_desc in presets.items() %}
                                <option value="{{ preset_key }}" {% if preset_key == 'kindergarten_phonics' %}selected{% endif %}>
                                    {{ preset_desc }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Choose a preset that best matches your lesson type</div>
                    </div>

                    <!-- Custom Guidelines -->
                    <div class="mb-4">
                        <label for="custom_guidelines" class="form-label">
                            <i class="fas fa-edit me-2"></i>Custom Annotation Guidelines
                        </label>
                        <textarea class="form-control" id="custom_guidelines" name="custom_guidelines" rows="4" 
                                  placeholder="Enter any specific guidelines or focus areas for the AI to consider when analyzing your lesson plan..."></textarea>
                        <div class="form-text">Optional: Provide specific instructions for the AI analysis</div>
                    </div>

                    <!-- Custom Parameters (Hidden by default) -->
                    <div id="customParameters" style="display: none;">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h5 class="mb-0">Custom Parameters</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Pedagogical Approach</label>
                                        <select class="form-select" name="pedagogical_approach">
                                            <option value="Constructivist">Constructivist</option>
                                            <option value="Behaviorist">Behaviorist</option>
                                            <option value="Cognitivist">Cognitivist</option>
                                            <option value="Humanistic">Humanistic</option>
                                            <option value="Social Learning">Social Learning</option>
                                            <option value="Multisensory Learning">Multisensory Learning</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Engagement Level</label>
                                        <select class="form-select" name="engagement_level">
                                            <option value="High">High Interactive</option>
                                            <option value="Medium">Medium</option>
                                            <option value="Low">Low</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Assessment Type</label>
                                        <select class="form-select" name="assessment_type">
                                            <option value="Formative">Formative</option>
                                            <option value="Summative">Summative</option>
                                            <option value="Authentic">Authentic</option>
                                            <option value="Performance">Performance</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Differentiation</label>
                                        <select class="form-select" name="differentiation">
                                            <option value="Multi-level">Multi-level Support</option>
                                            <option value="Universal Design">Universal Design for Learning</option>
                                            <option value="Tiered">Tiered Instruction</option>
                                            <option value="Flexible Grouping">Flexible Grouping</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Language Focus</label>
                                        <select class="form-select" name="language_focus">
                                            <option value="Spanish">Spanish L1 Development</option>
                                            <option value="English">English as Second Language</option>
                                            <option value="Bilingual">Bilingual Education</option>
                                            <option value="General">General Language Arts</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Age Group</label>
                                        <select class="form-select" name="age_group">
                                            <option value="3-4 years">3-4 years (Pre-K)</option>
                                            <option value="5-6 years">5-6 years (Kindergarten)</option>
                                            <option value="6-7 years">6-7 years (1st Grade)</option>
                                            <option value="7-8 years">7-8 years (2nd Grade)</option>
                                            <option value="8-9 years">8-9 years (3rd Grade)</option>
                                            <option value="9-10 years">9-10 years (4th Grade)</option>
                                            <option value="10-11 years">10-11 years (5th Grade)</option>
                                            <option value="11-12 years">11-12 years (6th Grade)</option>
                                            <option value="12-13 years">12-13 years (7th Grade)</option>
                                            <option value="13-14 years">13-14 years (8th Grade)</option>
                                            <option value="14-15 years">14-15 years (9th Grade)</option>
                                            <option value="15-16 years">15-16 years (10th Grade)</option>
                                            <option value="16-17 years">16-17 years (11th Grade)</option>
                                            <option value="17-18 years">17-18 years (12th Grade)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Annotation Color Theme</label>
                                        <select class="form-select" name="annotation_theme" onchange="toggleCustomCategories(this.value)">
                                            <option value="educational">Educational Psychology (Default)</option>
                                            <option value="vibrant">Vibrant (High Contrast)</option>
                                            <option value="pastel">Pastel (Soft Colors)</option>
                                            <option value="academic">Academic (Professional)</option>
                                            <option value="monochrome">Monochrome (Print-Friendly)</option>
                                            <option value="warm">Warm Tones</option>
                                            <option value="cool">Cool Tones</option>
                                            <option value="custom">Custom User-Defined Categories</option>
                                        </select>
                                        <div class="form-text">Choose the color scheme for smart overlay annotations</div>
                                    </div>
                                </div>
                                
                                <!-- Custom Category Definitions (Hidden by default) -->
                                <div id="customCategoryDefinitions" style="display: none;">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">🎨 Custom Color Category Definitions</h6>
                                            <small>Define what each color represents for AI annotation categorization</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">🔴 Red Category Meaning</label>
                                                    <input type="text" class="form-control" name="category1_definition" 
                                                           placeholder="e.g., Critical Issues, Urgent Problems" 
                                                           value="Critical Issues">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">🟢 Green Category Meaning</label>
                                                    <input type="text" class="form-control" name="category2_definition" 
                                                           placeholder="e.g., Strengths, Success Areas" 
                                                           value="Strengths & Successes">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">🔵 Blue Category Meaning</label>
                                                    <input type="text" class="form-control" name="category3_definition" 
                                                           placeholder="e.g., Student Engagement, Participation" 
                                                           value="Student Engagement">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">🟠 Orange Category Meaning</label>
                                                    <input type="text" class="form-control" name="category4_definition" 
                                                           placeholder="e.g., Teaching Strategies, Methods" 
                                                           value="Teaching Strategies">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">🟣 Purple Category Meaning</label>
                                                    <input type="text" class="form-control" name="category5_definition" 
                                                           placeholder="e.g., Assessment, Evaluation" 
                                                           value="Assessment Methods">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">🟤 Brown/Olive Category Meaning</label>
                                                    <input type="text" class="form-control" name="category6_definition" 
                                                           placeholder="e.g., Resources, Materials" 
                                                           value="Resources & Materials">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">🩷 Magenta Category Meaning</label>
                                                    <input type="text" class="form-control" name="category7_definition" 
                                                           placeholder="e.g., Extensions, Advanced Activities" 
                                                           value="Extensions & Enrichment">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">🔷 Teal Category Meaning</label>
                                                    <input type="text" class="form-control" name="category8_definition" 
                                                           placeholder="e.g., Cultural Considerations, Diversity" 
                                                           value="Cultural Considerations">
                                                </div>
                                            </div>
                                            <div class="alert alert-info mt-3">
                                                <i class="fas fa-info-circle"></i> 
                                                <strong>How it works:</strong> The AI will categorize annotations based on your definitions above, 
                                                then apply the corresponding colors in the smart overlay PDF.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Focus Areas -->
                                <div class="mb-3">
                                    <label class="form-label">Focus Areas</label>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="focus_area_1" value="Student Engagement">
                                                <label class="form-check-label">Student Engagement</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="focus_area_2" value="Assessment Strategies">
                                                <label class="form-check-label">Assessment Strategies</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="focus_area_3" value="Differentiated Instruction">
                                                <label class="form-check-label">Differentiated Instruction</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="focus_area_4" value="Phonological Awareness">
                                                <label class="form-check-label">Phonological Awareness</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="focus_area_5" value="Vocabulary Development">
                                                <label class="form-check-label">Vocabulary Development</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="focus_area_6" value="Reading Comprehension">
                                                <label class="form-check-label">Reading Comprehension</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="focus_area_7" value="Classroom Management">
                                                <label class="form-check-label">Classroom Management</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="focus_area_8" value="Cultural Responsiveness">
                                                <label class="form-check-label">Cultural Responsiveness</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="focus_area_9" value="Technology Integration">
                                                <label class="form-check-label">Technology Integration</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row mt-4">
                        <div class="col-md-8">
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                    <i class="fas fa-magic me-2"></i>Analyze Lesson Plan
                                </button>
                            </div>
                        </div>
                        {% if current_user.is_authenticated %}
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button type="button" class="btn btn-outline-success btn-lg" onclick="saveCurrentProfile()">
                                    <i class="fas fa-save me-2"></i>Save Profile
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Feedback Link -->
        <div class="text-center mt-4">
            <div class="card border-0 bg-light">
                <div class="card-body py-3">
                    <p class="mb-2 text-muted">
                        <i class="fas fa-comment-dots me-2"></i>
                        Found a bug or have suggestions for improvement?
                    </p>
                    <a href="{{ url_for('feedback') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-bug me-1"></i>Report Issues & Feedback
                    </a>
                </div>
            </div>
        </div>

        <!-- Processing Modal -->
        <div class="modal fade" id="processingModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center py-5">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5>Processing Your Lesson Plan</h5>
                        <p class="text-muted">AI is analyzing your lesson plan and generating annotations. This may take a few moments...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleCustomParameters() {
    const preset = document.getElementById('preset').value;
    const customParams = document.getElementById('customParameters');
    
    if (preset === 'custom') {
        customParams.style.display = 'block';
    } else {
        customParams.style.display = 'none';
    }
}

function toggleCustomCategories(themeValue) {
    const customCategories = document.getElementById('customCategoryDefinitions');
    
    if (themeValue === 'custom') {
        customCategories.style.display = 'block';
    } else {
        customCategories.style.display = 'none';
    }
}

function loadSavedProfile() {
    const profileSelect = document.getElementById('saved_profile');
    const profileId = profileSelect.value;
    
    if (profileId) {
        // Load profile data via AJAX
        fetch(`/api/profile/${profileId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateFormFromProfile(data.profile);
                    // Show custom parameters if needed
                    document.getElementById('preset').value = 'custom';
                    toggleCustomParameters();
                } else {
                    alert('Error loading profile: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading profile');
            });
    }
}

function populateFormFromProfile(profile) {
    // Populate form fields from profile data
    if (profile.pedagogical_approach) {
        document.querySelector('[name="pedagogical_approach"]').value = profile.pedagogical_approach;
    }
    if (profile.engagement_level) {
        document.querySelector('[name="engagement_level"]').value = profile.engagement_level;
    }
    if (profile.assessment_type) {
        document.querySelector('[name="assessment_type"]').value = profile.assessment_type;
    }
    if (profile.differentiation) {
        document.querySelector('[name="differentiation"]').value = profile.differentiation;
    }
    if (profile.language_focus) {
        document.querySelector('[name="language_focus"]').value = profile.language_focus;
    }
    if (profile.age_group) {
        document.querySelector('[name="age_group"]').value = profile.age_group;
    }
    if (profile.annotation_theme) {
        document.querySelector('[name="annotation_theme"]').value = profile.annotation_theme;
        toggleCustomCategories(profile.annotation_theme);
    }
    if (profile.custom_guidelines) {
        document.querySelector('[name="custom_guidelines"]').value = profile.custom_guidelines;
    }
    
    // Handle focus areas
    if (profile.focus_areas) {
        // Clear existing checkboxes
        document.querySelectorAll('[name^="focus_area_"]').forEach(cb => cb.checked = false);
        
        // Check matching focus areas
        profile.focus_areas.forEach((area, index) => {
            const checkbox = document.querySelector(`[name="focus_area_${index + 1}"][value="${area}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
    }
    
    // Handle custom category definitions
    if (profile.custom_category_definitions) {
        Object.entries(profile.custom_category_definitions).forEach(([key, value]) => {
            const input = document.querySelector(`[name="${key}_definition"]`);
            if (input) {
                input.value = value;
            }
        });
    }
}

function saveCurrentProfile() {
    const profileName = prompt('Enter a name for this profile:');
    if (!profileName) return;
    
    const profileDescription = prompt('Enter a description (optional):') || '';
    const setAsDefault = confirm('Set this as your default profile?');
    
    // Collect current form data
    const formData = new FormData(document.getElementById('uploadForm'));
    formData.append('profile_name', profileName);
    formData.append('profile_description', profileDescription);
    if (setAsDefault) {
        formData.append('set_as_default', 'on');
    }
    
    // Save profile via AJAX
    fetch('/save_profile', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Profile saved successfully!');
            location.reload(); // Refresh to show new profile in dropdown
        } else {
            alert('Error saving profile: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving profile');
    });
}

document.getElementById('uploadForm').addEventListener('submit', function() {
    document.getElementById('submitBtn').disabled = true;
    const modal = new bootstrap.Modal(document.getElementById('processingModal'));
    modal.show();
});
</script>
{% endblock %}